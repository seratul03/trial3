<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Base - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="assets/css/custom.css">
</head>
<body class="bg-gray-100">
    <div class="flex h-screen">
        <!-- Sidebar (same as dashboard) -->
        <aside class="w-64 bg-white shadow-lg">
            <div class="p-6 border-b">
                <h1 class="text-xl font-bold text-gray-800">Admin Panel ‚óè UniBot</h1>
                <p class="text-sm text-gray-600 mt-1" id="userName">Loading...</p>
                <p class="text-xs text-gray-500" id="userRole"></p>
            </div>
            
            <nav class="p-4">
                <a href="dashboard.html" class="sidebar-link block px-4 py-2 text-gray-700 hover:bg-blue-50 rounded mb-2">Dashboard</a>
                <a href="announcements.html" class="sidebar-link block px-4 py-2 text-gray-700 hover:bg-blue-50 rounded mb-2">Announcements</a>
                <a href="kb.html" class="sidebar-link block px-4 py-2 text-gray-700 hover:bg-blue-50 rounded mb-2">Knowledge Base</a>
                <a href="logs.html" class="sidebar-link block px-4 py-2 text-gray-700 hover:bg-blue-50 rounded mb-2">Query Logs</a>
                <a href="feedback.html" class="sidebar-link block px-4 py-2 text-gray-700 hover:bg-blue-50 rounded mb-2">Feedback</a>
                <a href="analytics.html" class="sidebar-link block px-4 py-2 text-gray-700 hover:bg-blue-50 rounded mb-2">Analytics</a>
                <a href="settings.html" class="sidebar-link block px-4 py-2 text-gray-700 hover:bg-blue-50 rounded mb-2">Settings</a>
                <button onclick="logout()" class="w-full text-left px-4 py-2 text-red-600 hover:bg-red-50 rounded mt-4">Logout</button>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto">
            <header class="bg-white shadow-sm p-6">
                <h2 class="text-2xl font-bold text-gray-800">Knowledge Base</h2>
            </header>

            <div class="p-6">
                <!-- Tabs -->
                <div class="mb-6 border-b border-gray-200">
                    <nav class="flex space-x-8">
                        <button onclick="switchTab('faqs')" id="tab-faqs" class="tab-button py-4 px-1 border-b-2 border-blue-500 font-medium text-blue-600">
                            FAQs
                        </button>
                        <button onclick="switchTab('pdfs')" id="tab-pdfs" class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-gray-500 hover:text-gray-700">
                            PDF Documents
                        </button>
                        <button onclick="switchTab('tags')" id="tab-tags" class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-gray-500 hover:text-gray-700">
                            Tags
                        </button>
                    </nav>
                </div>

                <!-- FAQs Tab -->
                <div id="content-faqs" class="tab-content">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex space-x-4">
                                <input type="text" id="searchFAQ" placeholder="Search FAQs..." class="px-4 py-2 border rounded-lg w-64">
                                <select id="filterSubject" class="px-4 py-2 border rounded-lg">
                                    <option value="">All Subjects</option>
                                </select>
                            </div>
                            <button onclick="showCreateFAQModal()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                                + Add FAQ
                            </button>
                        </div>

                        <div id="faqList" class="space-y-4">
                            <div class="flex justify-center p-8"><div class="loader"></div></div>
                        </div>
                    </div>
                </div>

                <!-- PDFs Tab -->
                <div id="content-pdfs" class="tab-content hidden">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold">Uploaded PDFs</h3>
                            <button onclick="showUploadPDFModal()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                                + Upload PDF
                            </button>
                        </div>

                        <div id="pdfList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div class="flex justify-center col-span-full p-8"><div class="loader"></div></div>
                        </div>
                    </div>
                </div>

                <!-- Tags Tab -->
                <div id="content-tags" class="tab-content hidden">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold">Tags</h3>
                            <button onclick="showCreateTagModal()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                                + Create Tag
                            </button>
                        </div>

                        <div id="tagList" class="flex flex-wrap gap-3">
                            <div class="flex justify-center w-full p-8"><div class="loader"></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Create FAQ Modal -->
    <div id="createFAQModal" class="modal-overlay hidden">
        <div class="modal-content w-full max-w-2xl p-6">
            <h3 class="text-xl font-bold mb-4">Create FAQ</h3>
            <form id="createFAQForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Question *</label>
                    <textarea id="faqQuestion" required class="w-full px-3 py-2 border rounded-lg" rows="2"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Answer *</label>
                    <textarea id="faqAnswer" required class="w-full px-3 py-2 border rounded-lg" rows="4"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Subject</label>
                    <select id="faqSubject" class="w-full px-3 py-2 border rounded-lg">
                        <option value="">None</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Tags</label>
                    <select id="faqTags" multiple class="w-full px-3 py-2 border rounded-lg h-24">
                    </select>
                    <p class="text-sm text-gray-500 mt-1">Hold Ctrl/Cmd to select multiple</p>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideModal('createFAQModal')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Create FAQ
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Upload PDF Modal -->
    <div id="uploadPDFModal" class="modal-overlay hidden">
        <div class="modal-content w-full max-w-lg p-6">
            <h3 class="text-xl font-bold mb-4">Upload PDF</h3>
            <form id="uploadPDFForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">PDF File * (max 20MB)</label>
                    <input type="file" id="pdfFile" accept=".pdf" required class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Subject</label>
                    <select id="pdfSubject" class="w-full px-3 py-2 border rounded-lg">
                        <option value="">None</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Tags</label>
                    <select id="pdfTags" multiple class="w-full px-3 py-2 border rounded-lg h-24">
                    </select>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideModal('uploadPDFModal')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Upload
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="assets/js/api.js"></script>
    <script src="assets/js/utils.js"></script>
    <script>
        let subjects = [];
        let tags = [];
        let faqs = [];

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            document.getElementById(`tab-${tabName}`).classList.remove('border-transparent', 'text-gray-500');
            document.getElementById(`tab-${tabName}`).classList.add('border-blue-500', 'text-blue-600');

            // Update content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            document.getElementById(`content-${tabName}`).classList.remove('hidden');

            // Load data
            if (tabName === 'faqs') loadFAQs();
            else if (tabName === 'pdfs') loadPDFs();
            else if (tabName === 'tags') loadTags();
        }

        async function loadSubjectsAndTags() {
            const [subjectsResp, tagsResp] = await Promise.all([
                api.getSubjects(),
                api.getTags()
            ]);

            if (subjectsResp?.success) {
                subjects = subjectsResp.data;
                const selects = ['filterSubject', 'faqSubject', 'pdfSubject'];
                selects.forEach(id => {
                    const select = document.getElementById(id);
                    if (select) {
                        select.innerHTML = '<option value="">All Subjects</option>' +
                            subjects.map(s => `<option value="${s.id}">${s.code} - ${s.name}</option>`).join('');
                    }
                });
            }

            if (tagsResp?.success) {
                tags = tagsResp.data;
                const selects = ['faqTags', 'pdfTags'];
                selects.forEach(id => {
                    const select = document.getElementById(id);
                    if (select) {
                        select.innerHTML = tags.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
                    }
                });
            }
        }

        async function loadFAQs() {
            const container = document.getElementById('faqList');
            showLoader(container);

            const response = await api.getFAQs({ limit: 50 });
            
            if (response?.success) {
                faqs = response.data.faqs;
                if (faqs.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500 p-8">No FAQs found. Create your first FAQ!</p>';
                } else {
                    container.innerHTML = faqs.map(faq => `
                        <div class="border rounded-lg p-4 hover:bg-gray-50">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-800 mb-2">${escapeHtml(faq.question)}</h4>
                                    <p class="text-gray-600 mb-3">${truncate(escapeHtml(faq.answer), 200)}</p>
                                    <div class="flex items-center space-x-2">
                                        ${faq.tags.map(t => `<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">${t.name}</span>`).join('')}
                                    </div>
                                </div>
                                <div class="flex space-x-2 ml-4">
                                    <button onclick="deleteFAQ(${faq.id})" class="text-red-600 hover:text-red-800">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            }
        }

        async function loadPDFs() {
            const container = document.getElementById('pdfList');
            showLoader(container);

            const response = await api.getPDFs({ limit: 50 });
            
            if (response?.success) {
                const pdfs = response.data.pdfs;
                if (pdfs.length === 0) {
                    container.innerHTML = '<p class="col-span-full text-center text-gray-500 p-8">No PDFs uploaded yet.</p>';
                } else {
                    container.innerHTML = pdfs.map(pdf => `
                        <div class="border rounded-lg p-4 hover:shadow-lg transition-shadow">
                            <div class="text-4xl mb-3 text-center">üìÑ</div>
                            <h4 class="font-semibold text-gray-800 mb-2 text-center">${escapeHtml(pdf.original_filename)}</h4>
                            <p class="text-sm text-gray-600 text-center mb-2">${formatFileSize(pdf.file_size || 0)}</p>
                            <div class="flex flex-wrap gap-1 justify-center mb-3">
                                ${pdf.tags.map(t => `<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">${t.name}</span>`).join('')}
                            </div>
                            <p class="text-xs text-gray-500 text-center">${formatDate(pdf.uploaded_at)}</p>
                        </div>
                    `).join('');
                }
            }
        }

        async function loadTags() {
            const container = document.getElementById('tagList');
            showLoader(container);

            const response = await api.getTags();
            
            if (response?.success) {
                const tagsList = response.data;
                if (tagsList.length === 0) {
                    container.innerHTML = '<p class="w-full text-center text-gray-500 p-8">No tags created yet.</p>';
                } else {
                    container.innerHTML = tagsList.map(tag => `
                        <div class="bg-blue-100 text-blue-800 px-4 py-2 rounded-full flex items-center space-x-2">
                            <span>${escapeHtml(tag.name)}</span>
                            <button onclick="deleteTag(${tag.id})" class="text-red-600 hover:text-red-800">‚úï</button>
                        </div>
                    `).join('');
                }
            }
        }

        function showCreateFAQModal() {
            showModal('createFAQModal');
        }

        function showUploadPDFModal() {
            showModal('uploadPDFModal');
        }

        function showCreateTagModal() {
            const tagName = prompt('Enter tag name:');
            if (tagName) {
                createTag(tagName);
            }
        }

        document.getElementById('createFAQForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const selectedTags = Array.from(document.getElementById('faqTags').selectedOptions).map(o => parseInt(o.value));
            const subjectId = document.getElementById('faqSubject').value;
            
            const response = await api.createFAQ({
                question: document.getElementById('faqQuestion').value,
                answer: document.getElementById('faqAnswer').value,
                subject_id: subjectId ? parseInt(subjectId) : null,
                tag_ids: selectedTags
            });

            if (response?.success) {
                showToast('FAQ created successfully!', 'success');
                hideModal('createFAQModal');
                e.target.reset();
                loadFAQs();
            } else {
                showToast(response.error || 'Failed to create FAQ', 'error');
            }
        });

        document.getElementById('uploadPDFForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fileInput = document.getElementById('pdfFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showToast('Please select a PDF file', 'error');
                return;
            }

            if (file.size > 20 * 1024 * 1024) {
                showToast('File size exceeds 20MB limit', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            
            const subjectId = document.getElementById('pdfSubject').value;
            if (subjectId) formData.append('subject_id', subjectId);
            
            const selectedTags = Array.from(document.getElementById('pdfTags').selectedOptions).map(o => o.value);
            formData.append('tag_ids', JSON.stringify(selectedTags.map(t => parseInt(t))));

            const response = await api.uploadPDF(formData);

            if (response?.success) {
                showToast('PDF uploaded and text extracted!', 'success');
                hideModal('uploadPDFModal');
                e.target.reset();
                loadPDFs();
            } else {
                showToast(response.error || 'Failed to upload PDF', 'error');
            }
        });

        async function deleteFAQ(id) {
            if (!confirm('Are you sure you want to delete this FAQ?')) return;
            
            const response = await api.deleteFAQ(id);
            if (response?.success) {
                showToast('FAQ deleted successfully', 'success');
                loadFAQs();
            } else {
                showToast(response.error || 'Failed to delete FAQ', 'error');
            }
        }

        async function createTag(name) {
            const response = await api.createTag(name);
            if (response?.success) {
                showToast('Tag created successfully', 'success');
                await loadSubjectsAndTags();
                loadTags();
            } else {
                showToast(response.error || 'Failed to create tag', 'error');
            }
        }

        async function deleteTag(id) {
            if (!confirm('Are you sure you want to delete this tag?')) return;
            
            const response = await api.deleteTag(id);
            if (response?.success) {
                showToast('Tag deleted successfully', 'success');
                await loadSubjectsAndTags();
                loadTags();
            } else {
                showToast(response.error || 'Failed to delete tag', 'error');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (checkAuth()) {
                loadSubjectsAndTags();
                loadFAQs();
            }
        });

        // Search functionality
        document.getElementById('searchFAQ').addEventListener('input', async (e) => {
            const query = e.target.value;
            if (query.length > 2) {
                const response = await api.getFAQs({ q: query });
                if (response?.success) {
                    faqs = response.data.faqs;
                    loadFAQs();
                }
            } else if (query.length === 0) {
                loadFAQs();
            }
        });
    </script>
</body>
</html>

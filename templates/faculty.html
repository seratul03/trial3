<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Faculty Directory</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='faculty-cards.css') }}">
</head>
<body>
    <button class="faculty-close-btn" onclick="window.close()" aria-label="Close">Ã—</button>
    <div class="container">
        <h1 class="page-title">Faculty Directory</h1>
        <div class="search-container">
            <input type="text" id="facultySearchInput" class="search-input" placeholder="Search by name, position, or research area..." oninput="searchFaculty()">
        </div>
            <div class="faculty-grid" id="facultyGrid">
                <!-- Faculty cards will be dynamically loaded here -->
            </div>
            </div>
    </div>

    <script>
        // Fetch faculty data and render cards
        async function loadFaculty() {
            try {
                const response = await fetch('/faculty-data');
                const rawList = await response.json();
                const list = Array.isArray(rawList) ? rawList : (rawList.faculty || rawList.teachers || []);

                const facultyMap = {};
                const keys = [];

                function slugify(name) {
                    return (name||'').toString().toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,'').replace(/\-+/g,'-').replace(/^-|-$/g,'');
                }

                list.forEach((faculty, idx) => {
                    const key = faculty.key || faculty.id || slugify(faculty.name) || `f${idx}`;
                    facultyMap[key] = faculty;
                    facultyMap[key].__key = key;
                    keys.push(key);
                });

                const listEl = document.getElementById('facultyList');
                const grid = document.getElementById('facultyGrid');
                grid.innerHTML = '';

                // Build grid cards (name + position + rating + contact + view card + details)
                list.forEach((faculty, idx) => {
                    const card = createFacultyCard(faculty);
                    grid.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading faculty:', error);
            }
        }

        function createFacultyCard(faculty) {
            const card = document.createElement('div');
            card.className = 'card';

            // Determine the rank for circle color
            let rankClass = 'blue';
            if ((faculty.position || '').includes('Professor & HOD') || (faculty.position || '') === 'Professor') {
                rankClass = 'gold';
            } else if ((faculty.position || '').includes('Associate Professor')) {
                rankClass = 'silver';
            }

            // Determine rating
            let rating = 4;
            if ((faculty.position || '').toLowerCase().includes('hod') || (faculty.position || '').toLowerCase().includes('head')) {
                rating = 5;
            }

            let starsHtml = '<div class="rating">';
            for (let i = 1; i <= 5; i++) {
                starsHtml += (i <= rating) ? '<i class="fas fa-star" aria-hidden="true"></i>' : '<i class="far fa-star" aria-hidden="true"></i>';
            }
            starsHtml += '</div>';

            // Contact link
            let contactHref = '#';
            if (faculty.email) contactHref = `mailto:${faculty.email}`;

            const connectId = faculty.key ? encodeURIComponent(faculty.key) : encodeURIComponent((faculty.name||'').toString().toLowerCase().replace(/\s+/g,'-'));
            const connectUrl = `/faculty_card?name=${connectId}`;

            let actionButtonsHtml = `<div class="action-row">`;
            actionButtonsHtml += `<button class="viewcard-btn" onclick="handleConnect(event, '${connectUrl}')"><i class="fas fa-id-card"></i> View Card</button>`;
            if (faculty.email) actionButtonsHtml += `<button class="contact-btn" onclick="handleContact(event, '${contactHref}')"><i class="fas fa-envelope"></i> Contact</button>`;
            actionButtonsHtml += `<button class="detail-btn" onclick="toggleDetails(this)">Detailed View</button>`;
            actionButtonsHtml += `</div>`;

            card.innerHTML = `
                <div class="profile-pic ${rankClass}">
                    <img src="/${faculty.photo || 'logo/Brainware_University.jpg'}" alt="${faculty.name || ''}" onerror="this.src='/logo/Brainware_University.jpg'">
                </div>
                <div class="card-content">
                    <div class="name">${faculty.name || ''}</div>
                    <div class="position">${faculty.position || ''}</div>
                    ${starsHtml}
                    ${actionButtonsHtml}
                    <div class="details-section" style="display: none;">
                        <div class="detail-item">
                            <strong>Department:</strong>
                            <span>${faculty.department || ''}</span>
                        </div>
                        ${(faculty.research || faculty.research_area) ? `
                        <div class="detail-item">
                            <strong>Research Areas:</strong>
                            <span>${(faculty.research || (faculty.research_area || []).join(', '))}</span>
                        </div>
                        ` : ''}
                        ${faculty.qualification ? `
                        <div class="detail-item">
                            <strong>Qualification:</strong>
                            <span>${faculty.qualification}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;

            return card;
        }

        function toggleDetails(button) {
            const card = button.closest('.card');
            const profilePic = card.querySelector('.profile-pic');
            const detailsSection = card.querySelector('.details-section');
            const isExpanded = card.classList.contains('expanded');
            
            if (isExpanded) {
                // Collapse - reverse animation
                detailsSection.classList.remove('show');
                detailsSection.classList.add('hide');
                profilePic.classList.remove('minimized');
                
                setTimeout(() => {
                    card.classList.remove('expanded');
                    detailsSection.style.display = 'none';
                    detailsSection.classList.remove('hide');
                }, 400);
                
                button.textContent = 'Detailed View';
            } else {
                // Expand
                card.classList.add('expanded');
                detailsSection.style.display = 'block';
                
                setTimeout(() => {
                    profilePic.classList.add('minimized');
                    detailsSection.classList.add('show');
                }, 50);
                
                button.textContent = 'Hide Details';
            }
        }

        // Handle contact button click: open mailto/tel or show alert when not available
        function handleContact(event, href) {
            // prevent card toggle when clicking contact
            event.stopPropagation();
            if (!href || href === '#') {
                alert('Contact information is not available for this faculty.');
                return;
            }
            window.location.href = href;
        }

        function renderProfileInPlace(key, facultyMap) {
            const faculty = facultyMap[key];
            if (!faculty) return;
            const container = document.getElementById('profileContainer');
            container.innerHTML = '';
            const card = createFacultyCard(faculty);
            // Add Connect button wired to open faculty_card viewer (preserve previous behavior)
            const connectId = faculty.key ? encodeURIComponent(faculty.key) : encodeURIComponent(faculty.name || '');
            const connectUrl = `faculty_card/index.html?name=${connectId}`;
            const actionRow = card.querySelector('.action-row');
            if (actionRow) {
                const connectBtn = document.createElement('button');
                connectBtn.className = 'connect-btn';
                connectBtn.innerHTML = '<i class="fas fa-link"></i> Connect';
                connectBtn.onclick = (e) => { e.stopPropagation(); try { window.open(connectUrl,'_blank'); } catch { window.location.href = connectUrl; } };
                actionRow.insertAdjacentElement('afterbegin', connectBtn);
            }
            container.appendChild(card);
        }

        // Handle Connect: open the faculty_card viewer and pass id or name
        function handleConnect(event, url) {
            event.stopPropagation();
            // open in a new tab/window so student keeps directory open
            try {
                window.open(url, '_blank');
            } catch (e) {
                // fallback: navigate
                window.location.href = url;
            }
        }

        // Search functionality
        function searchFaculty() {
            const searchInput = document.getElementById('facultySearchInput').value.toLowerCase().trim();
            const cards = document.querySelectorAll('.card');
            
            if (searchInput === '') {
                // Show all cards if search is empty
                cards.forEach(card => {
                    card.style.display = 'flex';
                });
                return;
            }
            
            cards.forEach(card => {
                const nameElement = card.querySelector('.name');
                const positionElement = card.querySelector('.position');
                const detailsSection = card.querySelector('.details-section');
                
                const name = nameElement ? nameElement.textContent.toLowerCase() : '';
                const position = positionElement ? positionElement.textContent.toLowerCase() : '';
                const research = detailsSection ? detailsSection.textContent.toLowerCase() : '';
                
                if (name.includes(searchInput) || position.includes(searchInput) || research.includes(searchInput)) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Load faculty on page load
        document.addEventListener('DOMContentLoaded', loadFaculty);
    </script>
</body>
</html>
